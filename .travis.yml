language: node_js
node_js: node

# Run 2 builds in parallel: OSX and Linux
matrix:
  include:
  - os: osx
    osx_image: xcode10.2
    language: node_js
    node_js: 11.6.0
    env:
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
  - os: linux
    dist: trusty
    sudo: required
    services: docker
    language: generic
notifications:
  email: false

# cache some stuff for speed
cache:
  yarn: true
  directories:
  - node_modules
  - "$HOME/.cache/electron"
  - "$HOME/.cache/electron-builder"

# Git lfs for large files
before_install:
- |
  if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    mkdir -p /tmp/git-lfs && curl -L https://github.com/github/git-lfs/releases/download/v2.3.1/git-lfs-$([ "$TRAVIS_OS_NAME" == "linux" ] && echo "linux" || echo "darwin")-amd64-2.3.1.tar.gz | tar -xz -C /tmp/git-lfs --strip-components 1
    export PATH="/tmp/git-lfs:$PATH"
  fi
before_script:
- git lfs pull

# main script: install, build, test, distribute
script:
  - echo "Installing deps"
  - yarn install
  - echo "Building GUI"
  - yarn run elm
  - echo "Running test"
  - yarn run test
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      docker run --rm \
        -v ${PWD}:/project \
        -v ~/.cache/electron:/root/.cache/electron \
        -v ~/.cache/electron-builder:/root/.cache/electron-builder \
        electronuserland/builder:wine \
        /bin/bash -c "yarn --link-duplicates --pure-lockfile && yarn release --linux --win"
    else
      yarn release
    fi

# Deploy to Github releases
deploy:
  provider: releases
  api_key:
    secure: VwtB2qRssnjCfd10XL+0Gz08fqCZxMxlAVV01/k/mcKCdhNDQTrdL/z3BL5G7hcaiU4MOlircSCUJgPBuH/G2gnkfpjL7T9wLI3JQ2If8a/Amyxh0X8eY9G1Ie231tEheqjnu+fbDyJ9wcWBBhbU4fVf3ZgcyzaLa98DRabrD0wHRGLbKGJNVxHF+JrRsBpmRhN47c/74DFf/1t5v575dRWChGIMvza+vQDUaj5u9lDtzWf6cP7Vv5mC1dWJ+uVONQX1A0Zs0/Llhonq82uEdNQ+q1IEDqPYeieeHGuZS/2SlfQfiteJlmIvZAUvzrDdzdz8Dr4rkF8Yqls2Gcgxm5mcQ+Ab+/cqmrxpUBS1rFdqQ8oujI2CaRPyYBQ1H1I+r/Xmrtd1kDYWF0AjcXno8z1tNAgvQuNKyNnHe5vAMqWfaahOQg2z2IxfeizkFkMNDLJ6JHYSAOZWFOx6Qd1EYno49Luo8s8eT8PjUItJ6btqZeQ+Rk/4Dsugk3Vtf97XSI7TdXiAJm/BjIsFE7lyz1SfsgcF4dfJ23DlEOiGLlwBwhQodTqC9/KYkxmGVIt2mj7pyUUoj/4+PR6iawPuc0sxNm4C9vFVlfBjRrJWCB8kdvefwLNZfpapJfO8y1NCL//3QpntcF/WzaI+rzHvyuiWMYYrP5MdV2QwcytmeU8=
  file:
    - dist/*.dmg
    - dist/*.AppImage
    - dist/*.exe
  on:
    repo: IvantheTricourne/slippi-scripts
  skip_cleanup: true
  draft: true

before_cache:
- rm -rf $HOME/.cache/electron-builder/wine
